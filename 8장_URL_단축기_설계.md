# 8장: URL 단축기 설계

* 요구 사항, 고려해야 할 부분은 아래와 같다
    * 기존 URL보다 짧아져야 함
    * 해시 충돌 방지/해결
    * 고가용성
    * 데이터 모델 설계
    * 해싱 방식
    * 서비스 모니터링을 위한 리다이렉션 방식 고려

## 기존 URL보다 짧아져야 함
* 숫자(10) + 알파벳 대소문자 (52) = 62개의 문자를 이용해 URL을 만듦
* 5자리만으로도 62^5개 커버 가능

## 해시 충돌 방지/해결
* 충돌 후 해소: 단축 url이 충돌하면 url 뒤에 일정한 문자열 붙이기(DB 조회로 충돌 확인이 필요해서 성능 이슈-블룸 필터로 최적화 가능)
* 62진수 인코딩: id 값을 62로 반복해서 나눔. 이때, 각각의 나머지값에 해당하는 문자로 변환(충돌이 발생하지 않아 많이 사용하는 방식)

## 고가용성
* 여러 데이터센터에 다중화
* 하나의 URL에 대해 동시에 여러 곳에서 단축 url 생성을 시도하는 경우: 

## 데이터 모델 설계
* 관계형 데이터베이스에 테이블 형태로 저장한다면 id(PK), 기존 URL(NOT NULL), 단축 URL(UNIQUE, NOT NULL) 형태로 설계할 수 있음
* 단축 URL이 아니라 PK를 id로 설정한 이유
    * 단축 URL을 생성할 때, 기존 URL이 아닌 id를 기반으로 생성
    * 단축 URL을 PK로 설정한 경우, 단축 URL의 변경이 불가하여, 변경해야 할 때마다 삭제/생성이 이루어져야 함
    * 관계형 데이터베이스에서 데이터를 저장할 때, 인덱스를 설정하지 않아도 PK를 자동으로 인덱스화하여 B+tree 형태로 저장
    문자열 PK를 이용하면 인덱스 성능이 크게 떨어짐
    * 다른 테이블과 조인이 필요한 상황이 발생할 경우, id를 PK로 사용해야 저장 공간과 조인 비용이 적음

## 해싱 방식
* 해싱 함수(SHA 등)를 사용할 경우, 충돌 관리가 필요
* 62진수 인코딩을 이용할 겨웅, 충돌 관리가 필요하지 않음
    * 인코딩을 위한 유일한 id 값 생성은 트위터 스노우플레이트를 이용

## 서비스 모니터링을 위한 리다이렉션 방식 고려
* 301 (영구 리다이렉트): 클라이언트가 리다이렉트 경로를 캐싱해둠으로써, 서버 부하 감소
* 302 (일시 리다이렉트): 클라이언트가 매번 조회를 하기 때문에, 서비스 이용량 모니터링 가능